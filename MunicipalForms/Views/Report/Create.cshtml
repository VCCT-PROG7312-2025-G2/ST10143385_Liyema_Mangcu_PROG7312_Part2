@model MunicipalForms.Models.Report
@{
    ViewData["Title"] = "Submit Report";
}
<div class="container py-5">
    <div class="card shadow-lg border-0 p-4 mx-auto" style="max-width:650px; border-radius:16px;">
        <h2 class="text-center mb-4 text-primary fw-bold">Report an Issue</h2>

        <!-- PROGRESS BAR -->
        <div id="progressWrapper">
            <div class="progress mb-3" style="height: 20px; border-radius:10px;">
                <div id="progressBar" class="progress-bar bg-primary fw-semibold" role="progressbar" style="width:0%;">
                    0%
                </div>
            </div>
            <p id="progressMessage" class="text-center text-muted mb-4">Let’s get started</p>
        </div>

        <!-- REPORT FORM -->
        <form id="reportForm" asp-action="Create" method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="Location" class="form-label fw-semibold">Location</label>
                <input type="text" class="form-control" id="Location" name="Location" placeholder="e.g. Main Street, Zone 2" required />
            </div>
            <div class="mb-3">
                <label for="Category" class="form-label fw-semibold">Category</label>
                <select class="form-select" id="Category" name="Category" required>
                    <option value="">-- Select --</option>
                    <option>Sanitation</option>
                    <option>Roads</option>
                    <option>Utilities</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="Description" class="form-label fw-semibold">Description</label>
                <textarea class="form-control" id="Description" name="Description" rows="4" placeholder="Describe the issue in detail..." required></textarea>
            </div>
            <div class="mb-4">
                <label for="AttachmentPath" class="form-label fw-semibold">Attachment (optional)</label>
                <input type="file" class="form-control" id="AttachmentPath" name="AttachmentPath" accept="image/*" />
            </div>
            <div class="d-flex gap-2">
                <a href="/Home/Dashboard" class="btn btn-outline-secondary w-50">Back</a>
                <button type="submit" class="btn btn-primary w-50">Submit Report</button>
            </div>
        </form>

        <!-- CONFIRMATION SECTION -->
        <div id="confirmationSection" class="mt-4" style="display:none;">
            <h4 class="text-success mb-3 fw-bold">Submitted Reports</h4>
            <div id="confirmationDetails" class="mb-3"></div>
            <div class="d-flex gap-2">
                <button id="btnNewReport" class="btn btn-primary w-50">Submit Another Report</button>
                <a href="/Service/Index" class="btn btn-outline-secondary w-50">View Service Requests</a>
            </div>
        </div>
    </div>
</div>

<!-- SUCCESS MODAL -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4 border-0 shadow">
            <h3 class="text-success mb-3 fw-bold">Success!</h3>
            <p>Your report has been submitted successfully.</p>
            <div id="uploadedFilePreview" class="mb-3"></div>
            <div class="d-flex justify-content-around mt-3">
                <button id="btnGreat" class="btn btn-success">Great!</button>
                <a href="/Service/Index" class="btn btn-outline-secondary">View Service Requests</a>
            </div>
        </div>
    </div>
</div>

<!-- CONFETTI CANVAS -->
<canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.getElementById("reportForm");
        const progressBar = document.getElementById("progressBar");
        const progressMessage = document.getElementById("progressMessage");
        const modal = new bootstrap.Modal(document.getElementById("successModal"));
        const confirmationSection = document.getElementById("confirmationSection");
        const confirmationDetails = document.getElementById("confirmationDetails");
        const uploadedFilePreview = document.getElementById("uploadedFilePreview");
        const inputs = ["Location", "Category", "Description"];
        let reports = [];

        const messages = ["Good start!", "Almost there!", "Ready to submit!"];

        function updateProgress() {
            let filled = 0;
            inputs.forEach(id => {
                if (document.getElementById(id).value.trim() !== "") filled++;
            });
            const percent = (filled / inputs.length) * 100;
            progressBar.style.width = percent + "%";
            progressBar.innerText = Math.round(percent) + "%";               // ← FIXED TYPO
            progressMessage.innerText = filled > 0 ? messages[filled - 1] : "Let’s get started";
        }

        inputs.forEach(id => {
            document.getElementById(id).addEventListener("input", updateProgress);
        });

        // CONFETTI
        function launchConfetti() {
            const canvas = document.getElementById("confettiCanvas");
            const ctx = canvas.getContext("2d");
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const pieces = [];
            for (let i = 0; i < 100; i++) {
                pieces.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 8 + 4,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    speed: Math.random() * 3 + 2
                });
            }
            let animationId;
            function update() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    p.y += p.speed;
                    if (p.y > canvas.height) p.y = -p.size;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                });
                animationId = requestAnimationFrame(update);
            }
            update();
            setTimeout(() => {
                cancelAnimationFrame(animationId);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }, 1000);
        }

        function renderReports() {
            confirmationDetails.innerHTML = reports.length === 0
                ? "<p>No reports submitted yet.</p>"
                : reports.map((r, i) => `
                    <div class="card mb-3 shadow-sm border-0">
                        <div class="card-body">
                            <h5 class="card-title fw-bold text-primary">Report ${i + 1}</h5>
                            <p><strong>Location:</strong> ${r.location || ""}</p>
                            <p><strong>Category:</strong> ${r.category || ""}</p>
                            <p><strong>Description:</strong> ${r.description || ""}</p>
                            <p><strong>Submitted At:</strong> ${r.submittedAt || ""}</p>
                            ${r.file ? `<img src="${r.file}" class="img-fluid rounded mt-2" style="max-height:200px;"/>` : ""}
                        </div>
                    </div>
                `).join("");
        }

        // SUBMIT FORM
        form.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(form);

            fetch("/Report/Create", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    reports.push(data);
                    launchConfetti();
                    uploadedFilePreview.innerHTML = data.file
                        ? `<a href="${data.file}" target="_blank" class="btn btn-sm btn-outline-primary">View Uploaded File</a>`
                        : "";
                    modal.show();
                    form.style.display = "none";
                    confirmationSection.style.display = "block";
                    renderReports();
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("Failed to submit report.");
            });
        });

        // "Great!" → Go to Service Requests
        document.getElementById("btnGreat").addEventListener("click", () => {
            modal.hide();
            window.location.href = "/Service/Index";
        });

        // "Submit Another Report" → Reset form
        document.getElementById("btnNewReport").addEventListener("click", () => {
            form.reset();
            form.style.display = "block";
            confirmationSection.style.display = "none";
            progressBar.style.width = "0%";
            progressBar.innerText = "0%";                     // ← FIXED
            progressMessage.innerText = "Let’s get started";
            updateProgress();                                 // ← Re-run to clear any leftover %
        });
    </script>
}